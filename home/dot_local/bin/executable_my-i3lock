#!/usr/bin/env sh

# i3lock tokyonight-themed lock screen that adapts to the dimension of connected
# monitors.
#
# Usage:
#     my-i3lock
#
# Dependencies:
#     awk, bc, i3lock, xrandr
#
# Limitations:
#     This script is only compatible with xrandr environments as it relies on
#     xrandr to get the list of monitor dimensions. Particularly, it is Wayland
#     incompatible.

COLOR_BACKGROUND="#1a1b26"
COLOR_BLANK="#00000000"
COLOR_DEFAULT="#7aa2f7"
COLOR_TEXT="#7aa2f7"
COLOR_VERIFYING="#9ece6a"
COLOR_WRONG="#f7768e"
I3LOCK_DEFAULT_RADIUS="90"

# Get the minimum screen area of all connected monitors.
screen_area="$(
    xrandr |
        awk '
        /\*/ {
            split($1, arr, /x/)
            min = min ? ((arr[1] < min) ? arr[1] : min) : arr[1]
            min = (arr[2] < min) ? arr[2] : min
        }

        END {print min}
        ' \
        2>/dev/null
)"

# If the screen area is not found, the radius circle defaults to i3lock's
# default circle radius. Otherwise, calculate the circle radius based on the
# screen area.
if [ -z "$screen_area" ]; then
    radius_cirle="$I3LOCK_DEFAULT_RADIUS"
else
    radius_cirle="$(printf '%s\n' "$screen_area / 3" | bc)"
fi

# Calculate font sizes and padding based on the circle radius.
font_size_normal="$(printf '%s\n' "$radius_cirle / 3" | bc)"
font_size_small="$(printf '%s\n' "$radius_cirle / 6" | bc)"
padding_date_layout="$(printf '%s\n' "$radius_cirle / 30" | bc)"

# Launch i3lock with custom options.
i3lock \
	--color "$COLOR_BACKGROUND" \
	--clock \
	--indicator \
	--radius "$radius_cirle" \
	--ring-width "$(printf '%s\n' "$radius_cirle / 30" | bc)" \
	--inside-color "$COLOR_BLANK" \
	--insidever-color "$COLOR_BLANK" \
	--insidewrong-color "$COLOR_BLANK" \
	--ring-color "$COLOR_DEFAULT" \
	--ringver-color "$COLOR_VERIFYING" \
	--ringwrong-color "$COLOR_WRONG" \
	--line-uses-inside \
	--keyhl-color "$COLOR_VERIFYING" \
	--bshl-color "$COLOR_WRONG" \
	--separator-color "$COLOR_BLANK" \
	--verif-color "$COLOR_VERIFYING" \
	--wrong-color "$COLOR_WRONG" \
	--layout-color "$COLOR_TEXT" \
	--date-color "$COLOR_TEXT" \
	--time-color "$COLOR_TEXT" \
	--time-str "%H:%M:%S" \
	--date-str "%a, %b %e %Y" \
	--verif-text "Verifying..." \
	--wrong-text "Incorrect" \
	--keylayout 0 \
	--noinput-text "No Input" \
	--lock-text "Locking..." \
	--lockfailed-text "Lock Failed" \
	--greeter-text "" \
	--time-size "$font_size_normal" \
	--date-size "$font_size_small" \
	--layout-size "$font_size_small" \
	--verif-size "$font_size_normal" \
	--wrong-size "$font_size_normal" \
	--greeter-size "$font_size_normal" \
	--time-pos="ix:iy+$(printf '%s\n' "$font_size_normal / 4" | bc)" \
	--date-pos "tx:iy+$(
        printf \
            '%s\n' \
            "$radius_cirle / 2 + $font_size_small / 4 - $font_size_small / 2 - $padding_date_layout / 2" |
            bc
        )" \
	--layout-pos "tx:iy+$(
        printf \
            '%s\n' \
            "$radius_cirle / 2 + $font_size_small / 4 + $font_size_small / 2 + $padding_date_layout / 2" |
            bc
        )"
